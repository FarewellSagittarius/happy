name: Build & Publish Happy CLI

on:
  push:
    branches: [main]
    paths:
      - 'packages/happy-cli/**'
      - 'packages/happy-wire/**'
      - '.github/workflows/build-cli.yml'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-engines --network-timeout 600000

      - name: Build happy-wire
        run: yarn workspace @slopus/happy-wire build

      - name: Build happy-cli
        run: yarn workspace happy-coder build

      - name: Pack tarball
        working-directory: packages/happy-cli
        run: npm pack --ignore-scripts

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(node -p "require('./packages/happy-cli/package.json').version")
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG="cli-v${VERSION}-${SHORT_SHA}"
          TGZ=$(ls packages/happy-cli/*.tgz)

          # Rename to a clean name
          cp "$TGZ" packages/happy-cli/happy-coder.tgz

          # Delete existing release with same tag if exists
          gh release delete "$TAG" --yes 2>/dev/null || true
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" 2>/dev/null || true

          # Create release
          gh release create "$TAG" \
            packages/happy-cli/happy-coder.tgz \
            --title "Happy CLI ${VERSION} (${SHORT_SHA})" \
            --notes "Install: \`npm i -g https://github.com/FarewellSagittarius/happy/releases/download/${TAG}/happy-coder.tgz\`"

          # Also update the "latest-cli" release for stable URL
          gh release delete "latest-cli" --yes 2>/dev/null || true
          git tag -d "latest-cli" 2>/dev/null || true
          git push origin ":refs/tags/latest-cli" 2>/dev/null || true

          gh release create "latest-cli" \
            packages/happy-cli/happy-coder.tgz \
            --title "Happy CLI Latest" \
            --notes "Latest build: ${VERSION} (${SHORT_SHA})"$'\n\n'"Install: \`npm i -g https://github.com/FarewellSagittarius/happy/releases/download/latest-cli/happy-coder.tgz\`"
